/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

#include <boost/test/unit_test.hpp>
#include "gto_d1_kit/gto_d1.hpp"
#include <armadillo>

using namespace boost::unit_test; 

BOOST_AUTO_TEST_SUITE(gto_d1_kit_overlap_test)

const double ae = 1.1;
const double be = 1.7;
const double cc = ae * be / (ae + be);
const double xAB = 1.1;
const double yAB = 2.3;
const double zAB = 1.6;

#define CHECK_GRADIENT(grad, ref_grad)                                       \
    for (unsigned i = 0; i < grad.n_rows; ++i)                               \
        for (unsigned j = 0; j < grad.n_cols; ++j)                           \
            for (int k = 0; k < 3; ++k)                                      \
                BOOST_CHECK_CLOSE(grad(i, j, k), ref_grad(i, j, k), 1e-5)

#define GENERATE_TEST_CASE(m, n, d)                                          \
    arma::cube grad(2 * m + 1, 2 * n + 1, 3, arma::fill::zeros);             \
    arma::cube ref_grad(2 * m + 1, 2 * n + 1, 3, arma::fill::zeros);         \
    unsigned index = 0;                                                      \
            for(unsigned k = 0; k < 3; ++k)                            \
                for(unsigned j = 0; j < 2 * n + 1; ++j)                \
                    for(unsigned i = 0; i < 2 * m + 1; ++i, ++index)            \
                ref_grad(i, j, k) = d[index];                                \
    overlap_gradient_##m##n(ae, be, cc, xAB, yAB, zAB,                       \
                            grad.slice(0).begin(),                           \
                            grad.slice(1).begin(),                           \
                            grad.slice(2).begin(),                           \
                            2 * n + 1, 0, 0);                                \
    CHECK_GRADIENT(grad, ref_grad)


BOOST_AUTO_TEST_CASE(overlap_ss)
{
    const double data[] = {-1.1662122345883617, -2.4384437632302101, -1.6963087048557985};
    GENERATE_TEST_CASE(0, 0, data);
}

BOOST_AUTO_TEST_CASE(overlap_sp)
{
    const double data[] = {
        -0.19214883399147822, -1.0537560548244838, -0.73304769031268457,
        -1.0537560548244838,  -1.8914866615345189, -1.532736079744704,
        -0.73304769031268457, -1.532736079744704,  -0.75442973281086689
    };

    GENERATE_TEST_CASE(0, 1, data);
}

BOOST_AUTO_TEST_CASE(overlap_sd)
{
    const double data[] = {
        -0.30071900143340913, -1.1472428161790147, -0.010558735770391618, -0.2091958270841108,  0.86936785599429256,
        -1.4157652534057552,  -2.059294914044735,  -0.022077356610818791, -1.1472428161790149,  0.84174828406328484,
        -1.1472428161790147,  -1.1807063888434488,  0.57264800757944467,  -0.56468566422947564, 0.92504954348031188
    };
    
    GENERATE_TEST_CASE(0, 2, data);
}

BOOST_AUTO_TEST_CASE(overlap_sf)
{
    const double data[] = {
         0.79097765721691016, -0.42266910986517475, 2.4398948804253795, 0.55934651803516278, -0.13923864436919819, 1.7280576025298038, -0.47112251378423298,
        -0.019424993359731798,-1.9898983322727051,  4.3354713751564837, 1.1695427195280677,  -0.52159647657529329, 1.6731576991978474, -2.5110503808777342,
         0.31044508247994562, -1.1409175334914017,  2.8982242311633328, 1.0835790176935001,   0.15583517165844898, 1.3010047987360123, -2.1485892479232573
    };

    GENERATE_TEST_CASE(0, 3, data);
}

BOOST_AUTO_TEST_CASE(overlap_ps)
{
    const double data[] = {
        0.2969572888959209,
        1.628532084728748,
        1.132891885028694,

        1.628532084728748,
        2.923206658735166,
        2.368773941423633,

        1.132891885028694,
        2.368773941423633,
        1.165936859798612
    };

    GENERATE_TEST_CASE(1, 0, data);
}

BOOST_AUTO_TEST_CASE(overlap_pp)
{
    const double data[] = {
        -0.28817639822296326, 0.26832212175238579, 0.18665886730600759,
         0.26832212175238568, 1.2632428775248392,  1.0236487389723561,
         0.18665886730600748, 1.0236487389723556,  0.50385128584154326,
        
         0.26832212175238573, 1.2632428775248397,  1.0236487389723559,
         1.2632428775248399,  1.7704532440606287,  1.8374441854906762,
         1.0236487389723559,  1.837444185490676,   1.0535072340323177,
        
         0.1866588673060075,  1.0236487389723559,  0.50385128584154326,
         1.0236487389723559,  1.8374441854906753,  1.0535072340323177,
         0.50385128584154337, 1.0535072340323179,  0.12705006013919995
    };

    GENERATE_TEST_CASE(1, 1, data);
}

BOOST_AUTO_TEST_CASE(overlap_pd)
{
    const double data[] = {
        -0.45100517609245211, 0.2921270299638834,   0.092683307272299023, -0.31374273119474938,  -0.37724599932908592,
         0.36050197287873242, 1.3753148175941621,   0.20291524438374067,   0.29212702996388323,  -0.88808885859571896,
         0.29212702996388323, 0.78854319540616047, -0.25154568893472118,   0.14378817075878658,  -0.84452877439445584,

         0.36050197287873254, 1.3753148175941623,   0.2029152443837404,    0.29212702996388334,  -0.88808885859571907,
         1.3251725410989863,  1.9275236961439808,   0.41991421521129535,   1.3753148175941625,   -0.32761622383823824,
         1.3753148175941625,  1.4154309522833455,  -0.52595916777259866,   0.78854319540616069,  -0.81769833309004825, 
         
         0.29212702996388329, 0.78854319540616047, -0.25154568893472129,   0.14378817075878658,  -0.84452877439445584,
         1.3753148175941623,  1.4154309522833453,  -0.52595916777259877,   0.78854319540616047,  -0.81769833309004791,
         0.78854319540616069, 0.19883736176514732, -0.77440653783960378,   0.095096129539853094, -0.63582139076227939
    };

    GENERATE_TEST_CASE(1, 2, data);
}

BOOST_AUTO_TEST_CASE(overlap_pf)
{
    const double data[] = {
        -0.58712847086132336, -0.63390060293810557, -0.52168806788563071, 0.027275637752486079, -0.095012805579172077, -0.74985843181308032, -0.85349853395099373,
        -0.67938988427613445,  0.50669577663862542, -2.7167081663988837, -0.426251236570449,     0.23240832930577507,  -1.7652696648913402,   0.51082592053842291,
        -0.76837829558214144,  0.29051639791706985, -1.7907384731362737, -0.54902165453972518,   0.029600548867861697, -1.187759072907661,    0.45766187053325491,

        -0.67938988427613456,  0.50669577663862564, -2.7167081663988837, -0.42625123657044961,   0.23240832930577507,  -1.7652696648913409,   0.51082592053842302,
         0.5269671368985902,   1.8625676983970374,  -3.6639477525320649, -0.66011766074847611,   0.83352800681636341,  -0.65120846418721323,  2.2037448186074102,
         0.018869993549453644, 1.3677320679939344,  -3.17149976573487,   -1.1479543685830611,   -0.072751404889524626, -1.15002430168891,     2.4393060842812275,

        -0.76837829558214144,  0.2905163979170699,  -1.7907384731362737, -0.54902165453972507,   0.029600548867861624, -1.1877590729076606,   0.45766187053325508,
         0.018869993549453644, 1.367732067993934,   -3.1714997657348687, -1.1479543685830611,   -0.072751404889524626, -1.1500243016889098,   2.4393060842812266,
        -0.21338059727598879,  0.19213670265072871, -1.1492293952636468, -0.40970787248034846,  -0.51020364346117664,  -0.21909626666614479,  1.4768063109914078
    };

    GENERATE_TEST_CASE(1, 3, data);
}

BOOST_AUTO_TEST_CASE(overlap_ds)
{
    const double data[] = {
        -0.7182462100351678,
        -2.740108875006076,
        -0.02521879865820789,
        -0.4996495374157689,
         2.076424052746699,

        -3.381455853175729,
        -4.918481240982879,
        -0.05273021537625304,
        -2.740108875006076,
         2.01045664540735,

        -2.740108875006076,
        -2.820034267568237,
         1.367729538764129,
        -1.348712041010896,
         2.209415851783556
    };

    GENERATE_TEST_CASE(2, 0, data);
}

BOOST_AUTO_TEST_CASE(overlap_dp)
{
   const double data[] = {
        0.69700799941560776, -0.55713941263076838, -0.45146904630781953, 
       -0.45146904630781953, -2.1254865362818873, -1.2186576656277028, 
       -0.14323783851173486, -0.31359628677487161, 0.38875242835366003, 
        0.48487513002824895, -0.45146904630781948, -0.22221808208176105, 
        0.58301654441767803, 1.3725009632842931, 1.3051808331550681, 
       -0.5571394126307686, -2.0479939271529775, -2.1254865362818869, 
       -2.1254865362818869, -2.9789002576770582, -2.187484198983352, 
       -0.31359628677487178, -0.64895833259927549, 0.81284598655765206, 
       -0.45146904630781987, -2.1254865362818869, -1.2186576656277031, 
        1.3725009632842931, 0.50631598229545738, 1.263715605684619, 
       -0.45146904630781981, -2.1254865362818878, -1.2186576656277024, 
       -1.2186576656277026, -2.1874841989833529, -0.30729410454613654, 
        0.38875242835366025, 0.81284598655765283, 1.1968101039339338, 
       -0.22221808208176122, -1.2186576656277024, -0.14696674565250012, 
        1.3051808331550683, 1.2637156056846202, 0.98263305845079596
   };

   GENERATE_TEST_CASE(2, 1, data);
}

BOOST_AUTO_TEST_CASE(overlap_dd)
{
    const double data[] = {
         0.93645934692431287, -0.60656751230464589, -0.30716238032951587, 0.75884491148385635, 0.76869533468950013,
        -0.60656751230464556, -1.6373174520735223, 0.2918006249671643, -0.3477783255611025, 1.4942660240172481,
        -0.30716238032951576, 0.29180062496716525, 0.68253602253271972, -0.040480333768428065, 0.43423425605872612,
         0.75884491148385635, -0.34777832556110266, -0.04048033376842803, 0.37351189900286541, 0.63474040242464091,
         0.76869533468950013, 1.4942660240172492, 0.4342342560587264, 0.6347404024246408, -0.80241253747500529,

        -0.5844528113460864, -2.2296871365506421, -0.87645545571263828, -0.60656751230464589, 1.0557114191326122,
        -2.2296871365506417, -2.2947241944957262, 0.43009142507190079, -1.6373174520735227, 0.55123514664106721,
        -0.8764554557126385, 0.43009142507190062, 1.4271207743865959, 0.2918006249671648, 0.61748194621957331,
        -0.60656751230464578, -1.6373174520735223, 0.29180062496716475, -0.34777832556110261, 1.4942660240172483,
         1.0557114191326114, 0.55123514664106643, 0.61748194621957331, 1.4942660240172483, 0.86473250383100331,

        -0.60656751230464578, -1.6373174520735223, 0.29180062496716475, -0.34777832556110255, 1.4942660240172481,
        -1.6373174520735225, -0.41286245882147743, 1.5472013632255348, -0.23000760440991164, 0.97347293446731087,
         0.29180062496716508, 1.5472013632255357, 0.36911267177968837, 0.73996586936873465, -0.2352858794201646,
        -0.34777832556110261, -0.23000760440991164, 0.73996586936873421, -0.041941104674268335, 1.0054146755381939,
         1.4942660240172487, 0.97347293446731165, -0.2352858794201646, 1.0054146755381939, 0.041752627891787054
    };

    GENERATE_TEST_CASE(2, 2, data);
}

BOOST_AUTO_TEST_CASE(overlap_df)
{
    const double data[] = {
         1.1005370180604495, 1.316220247815203, 0.99138295499834661, -0.22246780549813225, 0.32844290504619744, 1.5279490816003933, 1.6823254824902161,
         1.143116717779902, -0.60322322378059301, 3.3678845504409258, 0.90547671476908442, -0.13548388937300476, 2.1015601613298855, -0.85949712110438514,
         0.51258451273825212, -0.19843407036397734, -0.0012131816779517946, 0.35142402601067496, 0.13387199771650571, -0.090663046835614935, -0.55898188415094763,
         0.98788101804197703, 0.75466104690566815, 0.62221545977011306, 0.040106394977208186, -0.11460262281897522, 0.89270927738548844, 1.436065601417567,
        -0.48596172203927346, 1.0804231569073957, -2.7894673893183239, -0.21251748163138715, 0.48507651428591991, -1.5949693517976316, 1.1283078042595633,

         0.51289654751359348, -0.8214650499381605, 3.9484962551215954, 0.026823562795652171, -0.57440976106369734, 2.0984559428219933, -0.70497095493133943,
        -0.8866557448838206, -2.2173938353900469, 4.4785933008885976, 1.5003218085178662, -0.1993140832726932, 0.77526612068128775, -3.7079409072377025,
         0.11201585146457982, -0.13356256395392757, 0.18394329106570745, 0.7347956907495935, 1.039779263964518, 0.30388346760940349, -1.6406009085010045,
         1.1431167177799022, -0.60322322378059323, 3.3678845504409267, 0.90547671476908465, -0.13548388937300476, 2.1015601613298855, -0.85949712110438548,
         1.3170189621922497, 1.4838324271906407, -0.71566416925595155, 0.16580129752204267, 1.0678292986884186, 1.7188438324427853, 1.7447244023789317,

         1.143116717779902, -0.60322322378059312, 3.3678845504409258, 0.90547671476908442, -0.13548388937300462, 2.1015601613298855, -0.85949712110438548,
        -0.022464798142058668, -0.39894932613280826, 2.0256462500915324, 0.88443436654079, 1.061564120200895, 0.3354468546373065, -2.9040030483561132,
         0.0067132309174030482, 1.180198317082914, -2.0561796378096675, -1.0596213589298902, 0.54826422308171929, -1.3457972455610514, 0.40713171455494962,
         0.9147572447099096, -0.084739784853870848, 1.1569275734982467, 0.42299034921516049, 0.14253985497795546, 0.34645358753608002, -0.54484817453179757,
         0.93726838146289848, 1.4860274411478571, -1.9281889205592424, -0.7301077067703291, 0.042355730226858956, 0.058721578352100727, 2.572003254327635
    };

    GENERATE_TEST_CASE(2, 3, data);
}

BOOST_AUTO_TEST_CASE(overlap_fs)
{
    const double data[] = {
         -2.919664335016289,
          1.560160283071078,
         -7.028110899239582,
         -2.064665246511462,
          0.5139590231298803,
         -6.378622840893258,
          1.389774242581193,

          0.07170172229628988,
          7.345131860597895,
        -12.45253955415703,
         -4.317027333614871,
          1.925321930439079,
         -6.17597578975133,
          7.35357217070004,

         -1.145917873947389,
          4.211365771632798,
         -7.820785812068022,
         -3.999717290704859,
         -0.575220284265936,
         -4.802281424635634,
          6.598551629480001
    };

    GENERATE_TEST_CASE(3, 0, data);
}

BOOST_AUTO_TEST_CASE(overlap_fp)
{
   const double data[] = {
    -1.4023151080902683, -1.6226750128578755, -1.8352175820102392, 
    -1.5140270599100205, 1.2102072681699405, 0.69387800824820822, 
    -0.92010507867181757, -4.9543027423208059, -3.03370573187471, 
    0.065145944714615545, -1.0180711352798333, -1.3112996542312445, 
    -0.22693141167256781, 0.55509096834189231, 0.070698831593487735, 
    -1.7909841883800013, -4.2162225880462598, -2.8368791080191249, 
    -1.6996103795774002, 0.90451060929759941, 0.87357238105103507, 
    -1.6226750128578746, 1.2586239881296917, 0.045069654014810626, 
    1.210207268169941, 4.4486121060887873, 3.2667319640516279, 
    -4.9543027423208041, -6.6006485685747371, -5.3431024064431165, 
    -1.0180711352798326, -1.5766446607959435, -2.7418083679380554, 
    0.55509096834189275, 1.9908230906605704, -0.17376161994274847, 
    -4.2162225880462589, -1.5553656706620158, -2.7467522577528509, 
    0.90451060929759997, 3.7778482618527121, 4.6222453644400234, 
    -1.8352175820102392, 0.045069654014810036, -0.50964456704760974, 
    0.69387800824820844, 3.2667319640516284, 0.45890501707488057, 
    -3.0337057318747105, -5.3431024064431192, -1.4652395488313343, 
    -1.3112996542312443, -2.7418083679380554, -0.97855847228777426, 
    0.070698831593487693, -0.17376161994274936, -1.2185855616552075, 
    -2.8368791080191245, -2.7467522577528518, -0.52329604187203171, 
    0.87357238105103596, 4.6222453644400243, 2.9346919747078082
   };

   GENERATE_TEST_CASE(3, 1, data);
}

BOOST_AUTO_TEST_CASE(overlap_fd)
{
   const double data[] = {
-1.7008299370025133, -1.7666349274780313, -0.79217606514093597, -1.5267252097012374, 0.75103175224251262, 
-2.0341585648053138, 0.93225407311546238, 0.3066708360170558, -1.1662943452178511, -1.6697448788568843, 
-1.094263301615847, -3.5344234595436057, 0.24834044264558522, -0.60678149725484554, 3.2323018910240706, 
0.34381388122438633, -1.3993731046431306, -0.54310985838013492, -0.061982610419321564, 0.32843610797577871, 
-0.50759358052594161, 0.20938419266737091, -0.20689308738005435, 0.17711314435659817, -0.74966370389642178, 
-2.3613758533824258, -3.2478657038734604, 0.14011561783685783, -1.3796416105048461, 2.464952634596338, 
-2.0695512689395406, 0.98475666538135831, 0.75488054953413353, -1.8503958191711034, -1.3000868807731933, 
-0.7926583007028245, 1.3702861511840883, -0.17311540680889551, -1.7666349274780304, -2.0353929415698393, 
1.269536895358975, 3.4268813819664334, 0.20641487156516219, 0.93225407311546293, -2.2931955692946242, 
-4.4926364206392115, -4.5802477347569859, 0.22576147397725335, -3.5344234595436039, 0.70809623850574799, 
-0.041454597047823359, -2.3186791586185191, -1.1355933402493725, -1.3993731046431304, -0.25623836889770257, 
0.88772417618935062, 0.30803085596689023, -1.6069315897633456, 0.2093841926673711, -1.6502816434275556, 
-3.2430682752703501, -1.1981385501438049, -0.46963808630544257, -3.2478657038734595, -2.6563950137752133, 
0.66553089656622721, 4.1130100834835082, 2.2968349123940808, 0.98475666538135886, -1.6519520921048323, 
-1.7666349274780309, 0.034718324401363611, -0.01037499323598696, -1.413715741824406, -1.4485056804426624, 
0.93225407311546293, 0.6165580494779761, -1.8239428536735938, 0.13096148568325491, -2.2965878635921433, 
-3.5344234595436044, -1.4113291968013522, 2.5388900584752254, -0.83019626537884594, 1.9867331187510722, 
-1.3993731046431306, -1.3668531119266754, 1.6375966456189204, -0.65371235787797544, 1.1283482740995983, 
0.20938419266737102, -1.6405990948559293, -0.847317435671748, -0.2202888667841133, -0.065458855805145627, 
-3.2478657038734595, -0.51841786625765529, 2.0798684704125328, -0.53542827164666895, -0.09075153018052079, 
0.98475666538135886, 3.5606355880298515, -0.33337232688783752, 0.67293548123166769, -2.9817029513273048
 };

   GENERATE_TEST_CASE(3, 2, data);
}

BOOST_AUTO_TEST_CASE(overlap_ff)
{
    const double data[] = {
        0.30481890061167949, -2.3905648531627066, 3.1586042864448434, -0.043621298848693237, -1.2198689721832341, 1.4928388716645555, -2.4248068459550822,
        -2.3905648531627057, -2.0229433035089501, -1.468414369156003, 0.11529235208006641, 0.14359075334302002, -2.3483564911395711, -3.6543143065817354,
        2.3334016982373846, -0.85297001828598429, 7.547677539872625, 1.1956439146663154, -0.29134369791971704, 4.0382738053041951, -1.4460196070594811,
        -0.043621298848692182, 0.1152923520800667, 1.7133784759033228, 0.39255125696103071, -0.28346738338985239, 1.3884645660070587, 0.76526618918040612,
        -1.2198689721832339, 0.14359075334302032, -0.57363220309585139, -0.28346738338985256, 0.69836390194587983, -0.47631765826227118, -1.0727458451680969,
        1.4928388716645578, -2.3483564911395711, 6.1824109643443474, 1.388464566007058, -0.47631765826227135, 3.4667496772134418, -3.4660790613978358,
        -1.7343122499434194, -2.9088131727409947, -1.4529473561759918, 0.73318857515628244, -0.9610056859690711, -2.5842052967324407, -3.6115088214226652,
        
        -1.6233836457651671, -1.1141037872177633, -2.6879914572941783, -0.36206042025705054, -1.4017851925033704, -4.0457859380970191, -1.4782437951293734,
        -1.1141037872177642, 1.262537348591495, -6.0586709268169132, -1.1081659607209675, 0.56267340290672596, -3.2251877330459648, 1.53132403517829,
        -2.0479250457485971, -3.7963533371659306, 9.2617725703206517, 1.7923583340071472, -0.7311496402320623, 0.52706716203313586, -7.5589193044495691,
        -0.36206042025705054, -1.1081659607209664, 2.5941524360071857, 0.82078899182761011, -1.2230048561216034, 0.53673269841398685, 0.17736291958398895,
        -1.4017851925033706, 0.56267340290672607, -1.7435719392498428, -1.2230048561216029, -0.21259738599601119, -0.89366465353313407, 1.3624270978522841,
        -4.0457859380970183, -3.2251877330459626, 1.3180399488629646, 0.53673269841398774, -0.89366465353313496, -3.7359973685923147, -5.3596657721994232,
        
        -0.67924482478568693, 0.93542260481903572, -7.0406438520728436, 0.67865725294072032, 1.0891024280090456, -3.2836138949626763, 0.6130396197675263,
        -2.1438618147686284, -1.7568946482934311, -0.21899229626115199, 0.20200928959633996, -0.19935808456259799, -2.0372020661316981, -3.0390698066525115,
        -1.7568946482934309, 0.22715334389367917, -2.5627569907343037, -1.1617170436696918, -0.34688811466446079, -0.79137605984058823, 1.3209901218351821,
        -0.1960723678417628, -0.90147814539871629, 6.0215066000552016, 1.1306697980289864, 1.4410832010919845, 0.59671089454818715, -6.1663514017327188,
        0.20200928959634026, -1.1617170436696926, 2.5250015919268471, 2.047771129120167, 0.76173662373998074, 1.3247227816392164, -2.3334221706578187,
        -0.19935808456259738, -0.34688811466446123, 1.5294487316952694, 0.76173662373998086, -0.33722501341457639, 2.1775041232343684, 0.42055337602066284,
        -2.0372020661316972, -0.79137605984058856, 1.9935568768316807, 1.3247227816392164, 2.177504123234367, -0.031271866196501838, -5.5903841924503439,
        -2.135415688136026, 0.97932724433883345, -7.0231841445525429, -1.687743236033979, 0.38574154173462766, -4.1935157694229144, 1.2365140283808205
    };

    GENERATE_TEST_CASE(3, 3, data);
}

BOOST_AUTO_TEST_SUITE_END()
